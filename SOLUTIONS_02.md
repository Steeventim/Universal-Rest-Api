# üîë Solutions - TP Niveau 2 : Premiers pas

## üìã **Solutions des exercices**

---

## üöÄ **Exercice 1 : Cr√©ation d'items (POST)**

### **1.1 Premier item via Swagger**

**Payload test√© :**

```json
{
  "name": "Smartphone Galaxy",
  "description": "T√©l√©phone Android derni√®re g√©n√©ration",
  "category": "electronics",
  "price": 799.99
}
```

**‚úÖ R√©ponse attendue :**

```json
{
  "id": "4",
  "name": "Smartphone Galaxy",
  "description": "T√©l√©phone Android derni√®re g√©n√©ration",
  "category": "electronics",
  "price": 799.99,
  "createdAt": "2024-06-08T10:30:00.000Z"
}
```

- **Code de statut :** `201 Created`
- **ID g√©n√©r√© :** S√©quentiel (4, 5, 6...)
- **createdAt :** Timestamp automatique

### **1.2 Cr√©ation via curl**

**Commande :**

```bash
curl -X POST http://localhost:3001/api/items \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Livre JavaScript",
    "description": "Guide complet ES6+",
    "category": "books",
    "price": 35.50
  }'
```

**‚úÖ Validation :**

1. **Item visible dans GET /api/items :** Oui
2. **ID unique et s√©quentiel :** Oui (ex: "5")
3. **Tous les champs pr√©sents :** Oui, y compris `id` et `createdAt`

---

## ‚ö†Ô∏è **Exercice 2 : Tests de validation**

### **2.1 Erreurs de validation**

#### Test A : Prix n√©gatif

```json
{
  "name": "Test Prix",
  "category": "electronics",
  "price": -50
}
```

**‚úÖ R√©sultat :**

- Code : `400`
- Message : `"Price must be positive"`

#### Test B : Cat√©gorie invalide

```json
{
  "name": "Test Cat√©gorie",
  "category": "invalid",
  "price": 25
}
```

**‚úÖ R√©sultat :**

- Code : `400`
- Message : `"Category must be one of: electronics, books, clothing, home, sports, toys"`

#### Test C : Nom vide

```json
{
  "name": "",
  "category": "books",
  "price": 15
}
```

**‚úÖ R√©sultat :**

- Code : `400`
- Message : `"Name is required"`

#### Test D : Prix manquant

```json
{
  "name": "Test Sans Prix",
  "category": "home"
}
```

**‚úÖ R√©sultat :**

- Code : `400`
- Message : `"Required"`

### **2.2 Analyse des sch√©mas**

**R√©ponses :**

1. **Cat√©gories autoris√©es :**
   `"electronics", "books", "clothing", "home", "sports", "toys"`

2. **Validation du prix :**

   - Doit √™tre un nombre (`z.number()`)
   - Doit √™tre positif (`.positive("Price must be positive")`)

3. **Champs obligatoires :**
   - `name` : string non vide
   - `category` : enum des cat√©gories valides
   - `price` : nombre positif
   - `description` : optionnel
   - `id` : g√©n√©r√© automatiquement
   - `createdAt` : g√©n√©r√© automatiquement

---

## üîÑ **Exercice 3 : Modification d'items (PUT)**

### **3.1 Modification compl√®te**

**Requ√™te :**

```json
PUT /api/items/1
{
  "name": "Laptop Pro Modifi√©",
  "description": "Ordinateur portable haute performance - MODIFI√â",
  "category": "electronics",
  "price": 1599.99
}
```

**‚úÖ R√©ponse attendue :**

```json
{
  "id": "1",
  "name": "Laptop Pro Modifi√©",
  "description": "Ordinateur portable haute performance - MODIFI√â",
  "category": "electronics",
  "price": 1599.99,
  "createdAt": "2024-01-01T00:00:00.000Z"
}
```

**V√©rifications :**

- ‚úÖ Code de statut : `200`
- ‚úÖ Tous les champs modifi√©s
- ‚úÖ `createdAt` inchang√©
- ‚úÖ Item visible dans GET /api/items

### **3.2 Modification partielle**

**Requ√™te :**

```json
PUT /api/items/1
{
  "price": 1299.99
}
```

**‚úÖ R√©ponses :**

- **Modification partielle fonctionne :** Oui
- **Autres champs restent inchang√©s :** Oui

### **3.3 Test d'erreur - ID inexistant**

**Commande :**

```bash
curl -X PUT http://localhost:3001/api/items/999 \
  -H "Content-Type: application/json" \
  -d '{"name": "Test", "category": "books", "price": 10}'
```

**‚úÖ R√©sultat :**

- Code : `404`
- Message : `"Item not found"`

---

## üóëÔ∏è **Exercice 4 : Suppression d'items (DELETE)**

### **4.1 Suppression normale**

**S√©quence :**

1. `GET /api/items` ‚Üí Liste avec l'item ID "3"
2. `DELETE /api/items/3` ‚Üí Code 204
3. `GET /api/items` ‚Üí Item absent de la liste

**‚úÖ R√©sultat :**

- Code de statut : `204 No Content`
- Item supprim√© d√©finitivement

### **4.2 Test d'erreur**

**Commande :**

```bash
curl -X DELETE http://localhost:3001/api/items/999
```

**‚úÖ R√©sultat :**

- Code : `404`
- Message : `"Item not found"`

---

## üîç **Exercice 5 : Tra√ßage du flow**

### **5.1 Suivre une requ√™te POST**

**Flow pour `POST /api/items` :**

1. **Point d'entr√©e** (`src/routes/items.routes.js`) :

   - **Ligne du POST :** `router.post('/', validateSchema(createItemSchema), itemsController.createItem);`
   - **Middleware appliqu√© :** `validateSchema(createItemSchema)`

2. **Validation** (`src/middleware/validation.middleware.js`) :

   - **Sch√©ma utilis√© :** `createItemSchema` (depuis items.schema.js)
   - **En cas d'erreur :** Retourne 400 avec message Zod

3. **Contr√¥leur** (`src/controllers/items.controller.js`) :

   - **M√©thode appel√©e :** `createItem`
   - **Code de statut retourn√© :** `201`

4. **Service** (`src/services/items.service.js`) :
   - **M√©thode du service :** `createItem`
   - **G√©n√©ration ID :** `String(mockData.length + 1)`

### **5.2 Tracer une erreur 404**

**Pour `GET /api/items/999` :**

1. **D√©tection d'erreur :** Dans `items.service.js`, m√©thode `getItemById`
2. **Code 404 :** Retourn√© par le controller quand service retourne `null`

**Code exact :**

```javascript
// Service
getItemById(id) {
  return mockData.find(item => item.id === id) || null;
}

// Controller
const item = itemsService.getItemById(id);
if (!item) {
  return res.status(404).json({ error: 'Item not found' });
}
```

---

## üõ†Ô∏è **Exercice 6 : Modifications du code**

### **6.1 Ajouter une cat√©gorie**

**Code modifi√© dans `src/schemas/items.schema.js` :**

```javascript
const validCategories = [
  "electronics",
  "books",
  "clothing",
  "home",
  "sports",
  "toys",
  "automotive", // ‚Üê Nouvelle cat√©gorie
];
```

**‚úÖ Test r√©ussi :**
Cr√©ation d'un item avec `"category": "automotive"` fonctionne apr√®s red√©marrage.

### **6.2 Ajouter des donn√©es de test**

**Code ajout√© dans `src/services/items.service.js` :**

```javascript
const mockData = [
  // ...items existants...
  {
    id: "4",
    name: "Tesla Model 3",
    description: "Voiture √©lectrique autonome",
    category: "automotive",
    price: 45000,
    createdAt: new Date("2024-01-04").toISOString(),
  },
  {
    id: "5",
    name: "Clean Code",
    description: "Livre sur les bonnes pratiques",
    category: "books",
    price: 42.99,
    createdAt: new Date("2024-01-05").toISOString(),
  },
];
```

**‚úÖ Validation :**

- Red√©marrage obligatoire
- GET /api/items retourne 5 items
- Nouveaux items avec donn√©es correctes

---

## üß™ **Exercice 7 : Workflow complet**

### **7.1 Sc√©nario de test complet**

**S√©quence ex√©cut√©e :**

1. **Cr√©er** casque audio :

   ```json
   POST /api/items
   {
     "name": "Casque Audio",
     "category": "electronics",
     "price": 150
   }
   ```

2. **R√©cup√©rer** : `GET /api/items/{id-g√©n√©r√©}`

3. **Modifier** : `PUT /api/items/{id}` avec `{"price": 129.99}`

4. **V√©rifier** : `GET /api/items/{id}` ‚Üí prix modifi√©

5. **Supprimer** : `DELETE /api/items/{id}`

6. **V√©rifier** : `GET /api/items/{id}` ‚Üí 404

**üìù Codes de statut :**

- **Cr√©ation :** 201
- **R√©cup√©ration :** 200
- **Modification :** 200
- **Suppression :** 204
- **V√©rification finale :** 404

### **7.2 Test de performance**

**Cr√©ation de 10 items :**

- **Serveur r√©actif :** Oui, les donn√©es sont en m√©moire
- **IDs s√©quentiels :** Oui (6, 7, 8, 9, 10, 11, 12, 13, 14, 15)

---

## üéØ **Exercice 8 : D√©bogage**

### **8.1 Provoquer des erreurs**

#### Erreur 1 : Types incorrects

```json
{
  "name": null,
  "category": "electronics",
  "price": "not-a-number"
}
```

**‚úÖ R√©sultat :**

- Code : 400
- Message Zod d√©taill√© sur les types incorrects
- Serveur ne plante pas (validation Zod prot√®ge)

#### Erreur 2 : Surcharge m√©moire

**1000 items rapidement :**

- Serveur reste stable (Node.js g√®re bien)
- M√©moire augmente mais reste g√©rable
- IDs continuent de 1001 √† 2000

### **8.2 Analyser les logs**

**Types de messages :**

- D√©marrage du serveur
- Requ√™tes HTTP (optionnel avec middleware de logging)
- Erreurs de validation (si activ√©es)

**Informations d'erreur :**

- Stack traces pour erreurs 500
- Messages de validation pour erreurs 400

---

## üèÜ **Quiz de compr√©hension - R√©ponses**

### **1. Ordre d'ex√©cution :**

1. **Route** (d√©finit l'endpoint)
2. **Middleware de validation** (v√©rifie les donn√©es)
3. **Controller** (g√®re la logique de contr√¥le)
4. **Service** (logique m√©tier)
5. **R√©ponse client** (JSON de retour)

### **2. R√¥le de `validateSchema` :**

‚úÖ **Applique les r√®gles Zod**

### **3. Stockage des donn√©es :**

‚úÖ **Variable JavaScript en m√©moire**

### **4. Retour de `createItem` :**

‚úÖ **L'objet item complet** (avec id et createdAt)

### **5. G√©n√©ration de l'ID :**

‚úÖ **Calcul sur la longueur du tableau** (`String(mockData.length + 1)`)

---

## üîß **Probl√®mes courants et solutions**

### **Erreur "Cannot set headers after they are sent"**

**Cause :** Double appel √† `res.json()` ou `res.status()`
**Solution :** Utiliser `return` apr√®s chaque r√©ponse

### **Validation qui ne fonctionne pas**

**Cause :** Middleware non appliqu√© ou mauvais ordre
**Solution :** V√©rifier l'ordre dans les routes

### **IDs qui se r√©p√®tent apr√®s red√©marrage**

**Cause :** Normal, donn√©es en m√©moire r√©initialis√©es
**Solution :** Attendu dans ce TP, sera r√©solu avec DB (TP 6)

### **Erreur CORS en front-end**

**Cause :** Headers CORS manquants
**Solution :** D√©j√† g√©r√© par `cors` middleware

---

## üìä **Points de validation**

### **Niveau Bronze (minimum)**

- ‚úÖ CRUD basique fonctionne
- ‚úÖ Validation de base comprise
- ‚úÖ Codes de statut corrects

### **Niveau Silver (objectif)**

- ‚úÖ Flow de requ√™te trac√©
- ‚úÖ Modifications de code r√©ussies
- ‚úÖ Gestion d'erreurs ma√Ætris√©e

### **Niveau Gold (excellence)**

- ‚úÖ Workflow complet automatis√©
- ‚úÖ D√©bogage autonome
- ‚úÖ Optimisations propos√©es

---

## üöÄ **Pr√©requis pour le TP 3**

Avant de continuer, vous devez ma√Ætriser :

‚úÖ **CRUD complet**

- Cr√©ation avec POST et validation
- Lecture avec GET (liste et d√©tail)
- Modification avec PUT (compl√®te et partielle)
- Suppression avec DELETE

‚úÖ **Validation des donn√©es**

- Sch√©mas Zod pour entr√©es
- Messages d'erreur explicites
- Codes de statut HTTP appropri√©s

‚úÖ **Architecture**

- Flow Route ‚Üí Middleware ‚Üí Controller ‚Üí Service
- S√©paration des responsabilit√©s
- Gestion centralis√©e des erreurs

**üéØ Si tout est acquis, passez au TP 3 !**

```bash
git checkout tp-03-validation
```
